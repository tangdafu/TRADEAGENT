# 加密货币交易智能体系统

基于 LangChain、LangGraph 和 Claude AI 的智能加密货币市场分析系统，支持实时数据采集、智能行情预判和AI驱动的交易建议。

## ✨ 核心特性

- 🚀 **并行数据采集** - 4个数据源同时采集，速度提升3-4倍
- 🎯 **智能行情预判** - 基于多因子信号检测，只在有交易机会时调用AI，节省API成本
- 🤖 **AI驱动分析** - 使用 Claude AI 进行深度市场分析和交易建议
- 📊 **多维度数据** - 资金费率、K线、爆仓数据、新闻情绪四大核心因子
- 🔧 **高度可配置** - 灵活的阈值配置，适应不同交易策略
- 📝 **详细日志** - 完整的决策过程记录，支持回溯分析

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    数据采集层（并行）                      │
├──────────┬──────────┬──────────┬────────────────────────┤
│ 资金费率  │  K线数据  │ 爆仓数据  │    消息面数据          │
└──────────┴──────────┴──────────┴────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    行情预判层                             │
│  • 5种信号检测（资金费率/价格/成交量/爆仓/新闻）           │
│  • 阈值过滤（默认需2个信号）                              │
│  • 智能触发决策                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    数据格式化层                           │
│  • 整合多维度数据                                        │
│  • 格式化为LLM可读文本                                   │
│  • 生成结构化分析输入                                     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    AI分析层（条件触发）                    │
│  • Claude AI 深度分析                                    │
│  • 市场趋势判断                                          │
│  • 风险提示                                              │
│  • 交易建议                                              │
└─────────────────────────────────────────────────────────┘
```

**工作流说明：**
1. **数据采集**：4个节点并行采集市场数据（3-4x速度提升）
2. **行情预判**：基于多因子信号检测，判断是否有交易机会
3. **数据格式化**：将原始数据整合并格式化为LLM输入
4. **AI分析**：仅在检测到交易机会时调用（节省API成本）

## 🚀 快速开始

### 安装依赖

```bash
pip install -r requirements.txt
```

### 配置环境变量

1. 复制配置模板：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，配置必需参数：

```bash
# LLM API 配置（必需）
LLM_API_BASE_URL=https://api.anthropic.com  # 或第三方API地址
LLM_API_KEY=your_api_key_here
MODEL_NAME=claude-sonnet-4-6

# 行情预判配置（可选，默认启用）
MARKET_SIGNAL_DETECTION_ENABLED=true
MIN_SIGNAL_COUNT=2                    # 触发AI分析的最少信号数
PRICE_CHANGE_THRESHOLD=5.0            # 价格波动阈值(%)
```

### 运行分析

```bash
# 分析 BTC
python src/main.py --symbol BTCUSDT

# 分析 ETH
python src/main.py --symbol ETHUSDT

# 详细输出模式
python src/main.py --symbol BTCUSDT --verbose
```

## 📊 数据源说明

### 必需数据（无需API密钥）
- ✅ **资金费率** - Binance公开API
- ✅ **K线数据** - Binance公开API

### 可选数据（需要API密钥）
- 🔑 **爆仓数据** - 需要 Binance API Key + Secret
- 🔑 **新闻情绪** - 需要 CryptoCompare API Key + NewsAPI Key

> 💡 提示：即使不配置可选API，系统仍可正常运行，只是缺少部分数据维度。

## ⚙️ 行情预判配置

### 信号类型

系统支持5种市场信号检测：

| 信号类型 | 默认阈值 | 说明 |
|---------|---------|------|
| 资金费率极端 | ±0.1% | 多空过度拥挤 |
| 资金费率变化 | ±0.05% | 情绪快速转变 |
| 价格大幅波动 | ±5% | 24h涨跌幅 |
| 成交量异常 | 2倍均值 | 放量信号 |
| 大额爆仓 | 3笔 | 市场恐慌 |
| 消息面极端 | ±0.5 | 情绪得分 |

### 配置策略

**保守策略（减少AI调用）**
```bash
MIN_SIGNAL_COUNT=3              # 需要3个信号
PRICE_CHANGE_THRESHOLD=8.0      # 更大的价格波动
VOLUME_SURGE_RATIO=3.0          # 更高的成交量要求
```

**灵敏策略（更频繁分析）**
```bash
MIN_SIGNAL_COUNT=1              # 只需1个信号
PRICE_CHANGE_THRESHOLD=3.0      # 更小的价格波动
VOLUME_SURGE_RATIO=1.5          # 更低的成交量要求
```

**禁用预判（始终调用AI）**
```bash
MARKET_SIGNAL_DETECTION_ENABLED=false
```

## 📁 项目结构

```
tradeAgent/
├── src/
│   ├── data_collectors/        # 数据采集器
│   │   ├── base.py             # 基础采集器（重试逻辑）
│   │   ├── funding_rate.py     # 资金费率采集
│   │   ├── kline_volume.py     # K线和成交量采集
│   │   ├── liquidation.py      # 爆仓数据采集
│   │   └── news_sentiment.py   # 新闻情绪采集
│   ├── analyzers/              # 分析器
│   │   ├── factor_analyzer.py  # 数据格式化分析
│   │   └── market_signal_detector.py  # 行情信号检测
│   ├── workflow/               # 工作流
│   │   └── trading_graph.py    # LangGraph工作流定义
│   ├── agent/                  # AI代理
│   │   ├── trading_agent.py    # 交易智能体
│   │   └── prompts.py          # 提示词模板
│   └── utils/                  # 工具类
│       ├── logger.py           # 日志配置
│       └── formatters.py       # 输出格式化
├── config/                     # 配置
│   └── settings.py             # 配置管理
├── logs/                       # 日志目录
│   ├── trade_agent.log         # 运行日志
│   └── workflow_graph.mmd      # 工作流图
├── .env                        # 环境变量配置
├── .env.example                # 配置模板
├── requirements.txt            # 依赖包
├── README.md                   # 项目说明
└── CLAUDE.md                   # 开发者文档
```

**核心模块说明：**
- **data_collectors** - 并行数据采集，支持重试和错误处理
- **analyzers** - 包含数据格式化和行情信号检测两大功能
- **workflow** - LangGraph工作流编排，实现并行+串行混合执行
- **agent** - Claude AI集成，支持官方和第三方API

## 📝 输出示例

### 完整工作流输出

```
【LangGraph 工作流结构】

入口节点（并行执行）:
  ├─ collect_funding_rate  (采集资金费率)
  ├─ collect_kline         (采集K线数据)
  ├─ collect_liquidation   (采集爆仓数据)
  └─ collect_news          (采集消息面数据)

数据处理节点:
  ├─ market_signal_detection (行情预判)
  ├─ format_data             (格式化数据)
  └─ ai_analysis             (AI分析)

工作流执行顺序:
  [并行] 4个数据采集节点同时执行
  ↓
  [等待] 所有采集完成后进入行情预判
  ↓
  [串行] 行情预判 → 格式化数据 → AI分析 → 结束
  注: 若无交易机会，AI分析将被跳过
======================================================================
```

### 有交易机会时

```
【K线数据决策信息】
  当前价格: 2030.3
  24h涨跌幅: 9.49%
  价格趋势: 上升
  成交量趋势: 放量
  成交量信号: 放量上涨，趋势延续

【资金费率决策信息】
  当前费率: 0.0058%
  24h平均: -0.0025%
  趋势: 上升
  是否极端: False
  信号: 正常

【行情预判结果】
  是否有交易机会: 是
  触发信号数: 2
  触发信号:
    • 价格大幅上涨
    • 资金费率快速上升
======================================================================
✅ 检测到交易机会，将进行AI分析

【数据格式化完成】
  交易对: ETHUSDT
  数据源: 资金费率✓ K线✓ 爆仓✓ 消息面✓
  格式化文本长度: 989 字符

【AI分析决策完成】
  分析结果长度: 898 字符

【市场趋势判断】
看多（短期） - 理由如下：
1. 价格强势上涨9.49%，突破$2000心理关口
2. 成交量配合放量上涨，确认趋势有效性
3. 资金费率从负转正，显示多头力量回归

【关键位置】
支撑位: $1,950 / 阻力位: $2,050

【交易建议】
开仓方向: 多单
建议仓位: 轻仓（10-15%）
止损位: $1,930
```

### 无交易机会时

```
【K线数据决策信息】
  当前价格: 2014.36
  24h涨跌幅: 8.63%
  价格趋势: 上升
  成交量趋势: 缩量
  成交量信号: 缩量上涨，易回落

【行情预判结果】
  是否有交易机会: 否
  触发信号数: 1/2
  触发信号:
    • 价格大幅上涨
======================================================================
⏭️  未检测到明显交易机会，跳过AI分析

【数据格式化完成】
  交易对: ETHUSDT
  数据源: 资金费率✓ K线✓ 爆仓✗ 消息面✗

【无需分析】
未检测到明显交易机会（触发信号数：1/2）
```

## 🔍 日志查看

所有决策过程都记录在日志文件中：

```bash
# 查看最新日志
tail -f logs/trade_agent.log

# 查看行情预判记录
grep "行情预判" logs/trade_agent.log

# 查看AI分析结果
grep "完整AI分析结果" logs/trade_agent.log -A 50
```

## 🛠️ 高级功能

### 自定义信号检测器

编辑 `src/analyzers/market_signal_detector.py` 添加自定义信号：

```python
def _check_custom_signal(self, data: Dict[str, Any]) -> Dict[str, Any]:
    """自定义信号检测"""
    # 实现你的信号逻辑
    if condition:
        return {
            "type": "自定义信号",
            "strength": "强",
            "value": value,
            "description": "信号描述"
        }
    return None
```

### 工作流可视化

系统自动生成 Mermaid 格式的工作流图：

```bash
# 查看工作流图
cat logs/workflow_graph.mmd
```

可以使用 [Mermaid Live Editor](https://mermaid.live/) 可视化。

## ⚠️ 免责声明

- 本系统仅供学习和研究使用
- 所有分析结果不构成投资建议
- 加密货币交易风险极高，请谨慎决策
- 建议在模拟环境充分测试后再考虑实盘使用

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请提交 Issue。

---

**⭐ 如果这个项目对你有帮助，请给个 Star！**
